// Copyright (C) 2013 rastating
//
// Version 0.2.4
//
// This program is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with this program.  If not, see http://www.gnu.org/licenses/.

(function(e){e.fn.graphly=function(n){var r=e.extend({data:null,paddingTop:1,paddingLeft:1,paddingBottom:1,paddingRight:1,showLabels:true,showLegend:true,width:null,height:null,theme:"default",removeBorders:false,customTheme:null},n);var i={width:0,height:0,paddingTop:r.paddingTop,paddingLeft:r.paddingLeft,paddingBottom:r.paddingBottom,paddingRight:r.paddingRight,barCount:0,largestValue:0,smallestValue:0,largestLabelWidth:0,colors:new Array,borderColors:new Array,top:0,left:0,bottom:0,right:0,decimalCount:0};var s={initialize:function(t,n){var o=0;var u=null;var a=null;var f=null;var l=null;if(r.customTheme==null){s.loadTheme(r.theme)}else{e.each(r.customTheme.colors,function(e,t){i.colors[e]=t.fill;i.borderColors[e]=t.stroke})}i.width=r.width==null?e(t).width():r.width;i.height=r.height==null?e(t).height():r.height;i.paddingLeft=r.paddingLeft<15?15:r.paddingLeft;i.paddingTop=r.paddingTop<15?15:r.paddingTop;i.paddingRight=r.paddingRight<15?15:r.paddingRight;i.paddingBottom=r.paddingBottom<15?15:r.paddingBottom;e.each(r.data.groups,function(t,r){e.each(r.values,function(e,t){if(u==null||u<t.value){u=t.value}if(a==null||a>t.value){a=t.value}var r=s.getDecimalPlaces(t.value);if(l==null||l<r){l=r}var c=n.measureText(t.label).width;if(f==null||f<c){f=c}if(t.color!=undefined){i.colors[e]=t.color}o+=1})});i.barCount=o;i.largestValue=u;i.smallestValue=a;i.largestLabelWidth=f;i.decimalCount=l},loadTheme:function(n){e.each(t.themes,function(t,r){if(r.name==n){e.each(r.colors,function(e,t){i.colors[e]=t.fill;i.borderColors[e]=t.stroke});return false}})},getFillColor:function(e){if(e>=i.colors.length){return"#9ed162"}else{return i.colors[e]}},getStrokeColor:function(e){if(e>=i.borderColors.length){return"#7ea74e"}else{return i.borderColors[e]}},drawVerticalLabel:function(e,t,n){e.save();e.translate(t,n);e.rotate(270*Math.PI/180);e.translate(-t,-n);e.fillText(r.data.yLabel,t,n);e.restore()},drawLegend:function(t){var n=i.width-i.paddingRight+15;var o=i.paddingTop+5;var u=o;var a=new Array;e.each(r.data.groups,function(t,n){e.each(n.values,function(t,n){if(e.inArray(n.label,a)==-1){a[a.length]=n.label}})});t.save();t.font='bold 14px "lucida grande",tahoma,verdana,arial,sans-serif';t.fillText("Legend",n,u);t.font='11px "lucida grande",tahoma,verdana,arial,sans-serif';e.each(a,function(e,r){u+=16;t.beginPath();t.rect(n,u,11,11);t.fillStyle=s.getFillColor(e);t.fill();t.closePath();t.textBaseline="top";t.fillText(r,n+13,u-1)});t.restore()},drawValueLabels:function(t){var n=i.smallestValue*-1+i.largestValue;var r=i.bottom-i.top;var o=r/10;var u=null;var a=new Array;t.save();t.font='11px "lucida grande",tahoma,verdana,arial,sans-serif';t.textBaseline="middle";t.textAlign="right";t.strokeStyle="#CCCCCC";t.lineWidth=1;for(var f=0;f<=10;f++){var l=f<10?n-n*(f*10/100)-i.smallestValue*-1:i.smallestValue;var c=t.measureText(s.roundToFixed(l,i.decimalCount));if(u==null||u<c.width){u=c.width}a[f]=s.roundToFixed(l,i.decimalCount)}i.left+=u;e.each(a,function(e,n){t.fillText(n,i.left,i.top+e*o);t.beginPath();t.moveTo(i.left+5,Math.round(i.top+e*o)+.5);t.lineTo(i.right,Math.round(i.top+e*o)+.5);t.stroke();t.closePath()});t.restore()},drawBars:function(t){t.save();t.font='11px "lucida grande",tahoma,verdana,arial,sans-serif';i.left+=5;var n=i.left;var o=i.right-i.left;var u=15;var a=(o-u*(r.data.groups.length+1))/i.barCount;var f=i.smallestValue*-1+i.largestValue;var l=(i.bottom-i.top)/f;var c=i.bottom-i.smallestValue*-1*l;if(!r.removeBorders){a-=9}e.each(r.data.groups,function(o,f){n+=u;e.each(f.values,function(e,o){var u=o.value*l*-1;if(!r.removeBorders){u+=2}t.beginPath();t.rect(n,c,a,u);t.fillStyle=s.getFillColor(e);t.fill();if(!r.removeBorders){t.lineWidth=2;t.strokeStyle=s.getStrokeColor(e);t.stroke()}t.closePath();var f=!r.removeBorders?a+9:a;n+=f;if(r.data.groups.length==1){var h=!r.removeBorders?n-4-f/2:n-a/2;t.textAlign="center";t.fillStyle="#000000";t.fillText(o.label,h,i.bottom+15)}});if(r.data.groups.length>1){t.textAlign="center";t.fillStyle="black";t.fillText(f.label,n-f.values.length/2*(!r.removeBorders?a+9:a)-(!r.removeBorders?5:0),i.bottom+15,i.bottom+15)}});t.restore()},drawAxis:function(e){var t=i.smallestValue*-1+i.largestValue;var n=(i.bottom-i.top)/t;e.beginPath();e.strokeStyle="#000000";e.lindWidth=1;e.moveTo(i.left+.5,i.top);e.lineTo(i.left+.5,i.bottom+.5);e.lineTo(i.right,i.bottom+.5);e.stroke();e.closePath();if(i.smallestValue<0){var r=i.bottom-i.smallestValue*-1*n;e.beginPath();e.strokeStyle="#343434";e.lineWidth=2;e.moveTo(i.left,r+.5);e.lineTo(i.right,r+.5);e.stroke();e.closePath()}},getDecimalPlaces:function(e){var t=(""+e).match(/(?:\.(\d+))?(?:[eE]([+-]?\d+))?$/);return!t?0:Math.max(0,(t[1]?t[1].length:0)-(t[2]?+t[2]:0))},roundToFixed:function(e,t){var n=Math.pow(10,t);return(Math.round(e*n)/n).toFixed(t)}};return this.each(function(){var t=e(this)[0];var n=t.getContext("2d");s.initialize(this,n);if(r.showLegend&&r.data.groups.length>1){i.paddingRight+=i.largestLabelWidth+55;s.drawLegend(n)}i.top=i.paddingTop;i.bottom=i.height-i.paddingBottom;i.left=i.paddingLeft;i.right=i.width-i.paddingRight;var o=i.bottom-i.top;if(r.showLabels){i.bottom-=35;n.font='bold 14px "lucida grande",tahoma,verdana,arial,sans-serif';n.textAlign="center";n.fillText(r.data.xLabel,(i.right+i.left)/2,i.bottom+45);s.drawVerticalLabel(n,i.paddingLeft,i.top+o/2);i.left+=14}i.smallestValue=i.smallestValue>0?0:i.smallestValue;s.drawValueLabels(n);s.drawBars(n);s.drawAxis(n)})};var t={themes:[{name:"default",colors:[{fill:"#d32226",stroke:"#a81b1e"},{fill:"#de585b",stroke:"#b14648"},{fill:"#e57b7e",stroke:"#b76264"},{fill:"#7fc223",stroke:"#659b25"},{fill:"#9ed162",stroke:"#7ea74e"},{fill:"#b3db83",stroke:"#8faf68"},{fill:"#875fbe",stroke:"#6c4c98"},{fill:"#a486ce",stroke:"#836ba4"},{fill:"#b7a0d8",stroke:"#9280ac"},{fill:"#e7cf00",stroke:"#b8a500"},{fill:"#eddb3e",stroke:"#bdaf31"},{fill:"#f1e267",stroke:"#c0b452"},{fill:"#5c7cda",stroke:"#4963ae"},{fill:"#849ce3",stroke:"#697cb5"},{fill:"#9eb1e9",stroke:"#7e8dba"},{fill:"#da5cb3",stroke:"#ae4993"},{fill:"#e384c9",stroke:"#b569af"},{fill:"#e99edb",stroke:"#ba7eb5"},{fill:"#da915c",stroke:"#ae7849"},{fill:"#e3b784",stroke:"#b59b69"},{fill:"#e9d29e",stroke:"#baa37e"}]}]}})(jQuery)