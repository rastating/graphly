// Copyright (C) 2013 rastating
//
// Version 0.02
//
// This program is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with this program.  If not, see http://www.gnu.org/licenses/.

(function(e){e.fn.graphly=function(t){var n=e.extend({data:null,paddingTop:1,paddingLeft:1,paddingBottom:1,paddingRight:1,showLabels:true,showLegend:true},t);var r=new Array;var i={width:0,height:0,paddingTop:n.paddingTop,paddingLeft:n.paddingLeft,paddingBottom:n.paddingBottom,paddingRight:n.paddingRight};var s={getBarCount:function(){var t=0;e.each(n.data.groups,function(e,n){t+=n.values.length});return t},getLargestValue:function(){var t=null;e.each(n.data.groups,function(n,r){e.each(r.values,function(e,n){if(t==null||t<n.value){t=n.value}})});return t},getSmallestValue:function(){var t=null;e.each(n.data.groups,function(n,r){e.each(r.values,function(e,n){if(t==null||t>n.value){t=n.value}})});return t},getLargestLabel:function(t){var r=null;e.each(n.data.groups,function(n,i){e.each(i.values,function(e,n){var i=t.measureText(n.label).width;if(r==null||r<i){r=i}})});return r},drawVerticalLabel:function(e,t,r){e.save();e.translate(t,r);e.rotate(270*Math.PI/180);e.translate(-t,-r);e.fillText(n.data.yLabel,t,r);e.restore()},drawLegend:function(t){var s=i.width-i.paddingRight+15;var o=i.paddingTop+5;var u=new Array;e.each(n.data.groups,function(t,n){e.each(n.values,function(t,n){if(e.inArray(n.label,u)==-1){u[u.length]=n.label}})});t.save();var a=o;t.font='bold 14px "lucida grande",tahoma,verdana,arial,sans-serif';t.fillText("Legend",s,a);t.font='11px "lucida grande",tahoma,verdana,arial,sans-serif';e.each(u,function(e,n){a+=16;t.beginPath();t.rect(s,a,11,11);t.fillStyle=r[e];t.fill();t.closePath();t.textBaseline="top";t.fillText(n,s+13,a-1)});t.restore()},setupcolors:function(){r[0]="#7CB9E8";r[1]="#FF0038";r[2]="#FFBF00";r[3]="#A4C639";r[4]="#00308F";r[5]="#BF00FF";r[6]="#A32638";r[7]="#FFDB58";r[8]="#E32636";r[9]="#C46210";r[10]="#EFDECD";r[11]="#E52B50";r[12]="#3B7A57";r[13]="#C9FFE5";r[14]="#FF7E00";r[15]="#FF033E";r[16]="#9966CC";r[17]="#B284BE";r[18]="#317873";r[19]="#CD9575";r[20]="#665D1E";r[21]="#915C83";r[22]="#841B2D";r[23]="#C54B8C";r[24]="#008000";r[25]="#8DB600";r[26]="#FBCEB1";r[27]="#00FFFF";r[28]="#7FFFD4";r[29]="#4B5320";r[30]="#3B444B";r[31]="#E9D66B";r[32]="#B2BEB5";r[33]="#87A96B";r[34]="#FF9966";r[35]="#A52A2A";r[36]="#FDEE00";r[37]="#6E7F80";r[38]="#568203";r[39]="#007FFF";r[40]="#F0FFFF";r[41]="#89CFF0";r[42]="#A1CAF1";r[43]="#F4C2C2";r[44]="#FEFEFA";r[45]="#FF91AF";r[46]="#21ABCD";r[47]="#FAE7B5";r[48]="#FFE135";r[49]="#E0218A";r[50]="#7C0A02";r[51]="#848482";r[52]="#98777B";r[53]="#BCD4E6";r[54]="#9F8170";r[55]="#F5F5DC";r[56]="#2E5894";r[57]="#9C2542";r[58]="#FFE4C4";r[59]="#3D2B1F";r[60]="#967117";r[61]="#CAE00D";r[62]="#BFFF00";r[63]="#FE6F5E";r[64]="#BF4F51";r[65]="#000000";r[66]="#3D0C02";r[67]="#253529";r[68]="#3B3C36";r[69]="#FFEBCD";r[70]="#A57164";r[71]="#318CE7";r[72]="#ACE5EE";r[73]="#FAF0BE";r[74]="#0000FF";r[75]="#1F75FE";r[76]="#0093AF";r[77]="#0087BD";r[78]="#333399";r[79]="#0247FE";r[80]="#A2A2D0";r[81]="#6699CC";r[82]="#0D98BA";r[83]="#126180";r[84]="#8A2BE2";r[85]="#5072A7";r[86]="#4F86F7";r[87]="#1C1CF0";r[88]="#DE5D83";r[89]="#79443B";r[90]="#0095B6";r[91]="#E3DAC9";r[92]="#CC0000";r[93]="#006A4E";r[94]="#873260";r[95]="#0070FF";r[96]="#B5A642";r[97]="#CB4154";r[98]="#1DACD6";r[99]="#66FF00";r[100]="#BF94E4";r[101]="#C32148";r[102]="#1974D2";r[103]="#FF007F";r[104]="#08E8DE";r[105]="#D19FE8";r[106]="#F4BBFF";r[107]="#FF55A3";r[108]="#FB607F";r[109]="#004225";r[110]="#CD7F32";r[111]="#737000";r[112]="#964B00";r[113]="#A52A2A";r[114]="#6B4423";r[115]="#1B4D3E";r[116]="#FFC1CC";r[117]="#E7FEFF";r[118]="#F0DC82";r[119]="#7BB661";r[120]="#480607";r[121]="#800020";r[122]="#DEB887";r[123]="#CC5500";r[124]="#E97451";r[125]="#8A3324";r[126]="#BD33A4";r[127]="#702963";r[128]="#536872";r[129]="#5F9EA0";r[130]="#91A3B0";r[131]="#006B3C";r[132]="#ED872D";r[133]="#E30022";r[134]="#FFF600";r[135]="#A67B5B";r[136]="#4B3621";r[137]="#1E4D2B";r[138]="#A3C1AD";r[139]="#C19A6B";r[140]="#EFBBCC";r[141]="#78866B";r[142]="#FFEF00";r[143]="#FF0800";r[144]="#E4717A";r[145]="#00BFFF";r[146]="#592720";r[147]="#C41E3A";r[148]="#00CC99";r[149]="#960018";r[150]="#D70040";r[151]="#EB4C42";r[152]="#5D8AA8";r[153]="#FFA6C9";r[154]="#B31B1B";r[155]="#99BADD";r[156]="#ED9121";r[157]="#00563F";r[158]="#062A78";r[159]="#703642";r[160]="#C95A49";r[161]="#92A1CF";r[162]="#ACE1AF";r[163]="#007BA7";r[164]="#2F847C";r[165]="#B2FFFF";r[166]="#4997D0";r[167]="#DE3163";r[168]="#EC3B83";r[169]="#007BA7";r[170]="#2A52BE";r[171]="#6D9BC3";r[172]="#007AA5";r[173]="#E03C31";r[174]="#A0785A";r[175]="#F7E7CE";r[176]="#36454F";r[177]="#232B2B";r[178]="#E68FAC";r[179]="#DFFF00";r[180]="#7FFF00";r[181]="#DE3163";r[182]="#FFB7C5";r[183]="#954535";r[184]="#DE6FA1";r[185]="#A8516E";r[186]="#AA381E";r[187]="#856088";r[188]="#7B3F00";r[189]="#D2691E";r[190]="#FFA700";r[191]="#98817B";r[192]="#E34234";r[193]="#D2691E";r[194]="#E4D00A";r[195]="#9FA91F";r[196]="#7F1734";r[197]="#FBCCE7";r[198]="#0047AB";r[199]="#D2691E";r[200]="#965A3E";r[201]="#6F4E37";r[202]="#9BDDFF";r[203]="#F88379";r[204]="#002E63";r[205]="#8C92AC";r[206]="#B87333";r[207]="#DA8A67";r[208]="#AD6F69";r[209]="#CB6D51";r[210]="#996666";r[211]="#FF3800";r[212]="#FF7F50";r[213]="#F88379";r[214]="#FF4040";r[215]="#893F45";r[216]="#FBEC5D";r[217]="#B31B1B";r[218]="#6495ED";r[219]="#FFF8DC";r[220]="#FFF8E7";r[221]="#FFBCD9";r[222]="#FFFDD0";r[223]="#DC143C";r[224]="#BE0032";r[225]="#00FFFF";r[226]="#00B7EB";r[227]="#58427C";r[228]="#FFD300";r[229]="#FFFF31";r[230]="#F0E130";r[231]="#00008B";r[232]="#666699";r[233]="#654321";r[234]="#5D3954";r[235]="#A40000";r[236]="#08457E";r[237]="#986960";r[238]="#CD5B45";r[239]="#008B8B";r[240]="#536878";r[241]="#B8860B";r[242]="#A9A9A9";r[243]="#013220";r[244]="#00416A";r[245]="#1A2421";r[246]="#BDB76B";r[247]="#483C32";r[248]="#734F96";r[249]="#534B4F";r[250]="#543D37";r[251]="#8B008B";r[252]="#003366";r[253]="#4A5D23";r[254]="#556B2F";r[255]="#FF8C00";r[256]="#9932CC";r[257]="#779ECB";r[258]="#03C03C";r[259]="#966FD6";r[260]="#C23B22";r[261]="#E75480";r[262]="#003399";r[263]="#872657";r[264]="#8B0000";r[265]="#E9967A";r[266]="#560319";r[267]="#8FBC8F";r[268]="#3C1414";r[269]="#8CBED6";r[270]="#483D8B";r[271]="#2F4F4F";r[272]="#177245";r[273]="#918151";r[274]="#FFA812";r[275]="#483C32";r[276]="#CC4E5C";r[277]="#00CED1";r[278]="#D1BEA8";r[279]="#9400D3";r[280]="#9B870C";r[281]="#00703C";r[282]="#555555";r[283]="#D70A53";r[284]="#A9203E";r[285]="#EF3038";r[286]="#E9692C";r[287]="#DA3287";r[288]="#FAD6A5";r[289]="#B94E48";r[290]="#704241";r[291]="#C154C1";r[292]="#004B49";r[293]="#F5C71A";r[294]="#9955BB";r[295]="#CC00CC";r[296]="#D473D4";r[297]="#355E3B";r[298]="#FFCBA4";r[299]="#FF1493";r[300]="#843F5B";r[301]="#FF9933";r[302]="#00BFFF";r[303]="#4A646C";r[304]="#7E5E60";r[305]="#66424D";r[306]="#BA8759";r[307]="#1560BD";r[308]="#C19A6B";r[309]="#EDC9AF";r[310]="#B9F2FF";r[311]="#696969";r[312]="#9B7653";r[313]="#1E90FF";r[314]="#D71868";r[315]="#85BB65";r[316]="#664C28";r[317]="#967117";r[318]="#00009C";r[319]="#E5CCC9";r[320]="#E1A95F";r[321]="#555D50";r[322]="#C2B280";r[323]="#614051";r[324]="#F0EAD6";r[325]="#1034A6";r[326]="#7DF9FF";r[327]="#FF003F";r[328]="#00FFFF";r[329]="#00FF00";r[330]="#6F00FF";r[331]="#F4BBFF";r[332]="#CCFF00";r[333]="#72A0C1";r[334]="#3F00FF";r[335]="#8F00FF";r[336]="#FFFF33";r[337]="#50C878";r[338]="#1B4D3E";r[339]="#B48395";r[340]="#AB4B52";r[341]="#563C5C";r[342]="#96C8A2";r[343]="#44D7A8";r[344]="#C19A6B";r[345]="#801818";r[346]="#B53389";r[347]="#DE5285";r[348]="#F400A1";r[349]="#E5AA70";r[350]="#4D5D53";r[351]="#FDD5B1";r[352]="#4F7942";r[353]="#FF2800";r[354]="#6C541E";r[355]="#B22222";r[356]="#CE2029";r[357]="#E25822";r[358]="#FC8EAC";r[359]="#6B4423";r[360]="#F7E98E";r[361]="#EEDC82";r[362]="#A2006D";r[363]="#306030";r[364]="#FFBF00";r[365]="#FF1493";r[366]="#CCFF00";r[367]="#FF004F";r[368]="#014421";r[369]="#228B22";r[370]="#A67B5B";r[371]="#856D4D";r[372]="#0072BB";r[373]="#86608E";r[374]="#9EFD38";r[375]="#D473D4";r[376]="#C72C48";r[377]="#F64A8A";r[378]="#77B5FE";r[379]="#AC1E44";r[380]="#A6E7FF";r[381]="#FF00FF";r[382]="#C154C1";r[383]="#FF77FF";r[384]="#C74375";r[385]="#E48400";r[386]="#CC6666";r[387]="#DCDCDC";r[388]="#E49B0F";r[389]="#007F66";r[390]="#18453B";r[391]="#FE5A1D";r[392]="#B06500";r[393]="#6082B6";r[394]="#E6E8FA";r[395]="#00AB66";r[396]="#D4AF37";r[397]="#FFD700";r[398]="#85754E";r[399]="#996515";r[400]="#FCC200";r[401]="#FFDF00";r[402]="#DAA520";r[403]="#A8E4A0";r[404]="#6F2DA8";r[405]="#808080";r[406]="#808080";r[407]="#BEBEBE";r[408]="#465945";r[409]="#8C92AC";r[410]="#00FF00";r[411]="#1CAC78";r[412]="#008000";r[413]="#00A877";r[414]="#009F6B";r[415]="#00A550";r[416]="#66B032";r[417]="#ADFF2F";r[418]="#A99A86";r[419]="#00FF7F";r[420]="#663854";r[421]="#446CCF";r[422]="#5218FA";r[423]="#E9D66B";r[424]="#3FFF00";r[425]="#C90016";r[426]="#DA9100";r[427]="#808000";r[428]="#DF73FF";r[429]="#F400A1";r[430]="#F0FFF0";r[431]="#006DB0";r[432]="#49796B";r[433]="#FF1DCE";r[434]="#FF69B4";r[435]="#355E3B";r[436]="#71A6D2";r[437]="#FCF75E";r[438]="#319177";r[439]="#602F6B";r[440]="#002395";r[441]="#66023C";r[442]="#ED2939";r[443]="#B2EC5D";r[444]="#4C516D";r[445]="#138808";r[446]="#CD5C5C";r[447]="#E3A857";r[448]="#6F00FF";r[449]="#091F92";r[450]="#4B0082";r[451]="#002FA7";r[452]="#FF4F00";r[453]="#BA160C";r[454]="#C0362C";r[455]="#5A4FCF";r[456]="#B3446C";r[457]="#F4F0EC";r[458]="#009000";r[459]="#B2FFFF";r[460]="#FFFFF0";r[461]="#00A86B";r[462]="#264348";r[463]="#5B3256";r[464]="#F8DE7E";r[465]="#D73B3E";r[466]="#A50B5E";r[467]="#DA614E";r[468]="#343434";r[469]="#F4CA16";r[470]="#BDDA57";r[471]="#29AB87";r[472]="#4CBB17";r[473]="#7C1C05";r[474]="#3AB09E";r[475]="#C3B091";r[476]="#F0E68C";r[477]="#882D17";r[478]="#E79FC4";r[479]="#354230";r[480]="#E8000D";r[481]="#087830";r[482]="#D6CADD";r[483]="#26619C";r[484]="#FFFF66";r[485]="#A9BA9D";r[486]="#CF1020";r[487]="#B57EDC";r[488]="#E6E6FA";r[489]="#CCCCFF";r[490]="#FFF0F5";r[491]="#C4C3D0";r[492]="#9457EB";r[493]="#EE82EE";r[494]="#E6E6FA";r[495]="#FBAED2";r[496]="#967BB6";r[497]="#FBA0E3";r[498]="#7CFC00";r[499]="#FFF700";r[500]="#FFFACD";r[501]="#CCA01D";r[502]="#FDFF00";r[503]="#E3FF00";r[504]="#F6EABE";r[505]="#FFF44F";r[506]="#1A1110";r[507]="#545AA7";r[508]="#FDD5B1";r[509]="#ADD8E6";r[510]="#B5651D";r[511]="#E66771";r[512]="#F08080";r[513]="#93CCEA";r[514]="#F56991";r[515]="#E0FFFF";r[516]="#F984EF";r[517]="#FAFAD2";r[518]="#D3D3D3";r[519]="#90EE90";r[520]="#F0E68C";r[521]="#D39BCB";r[522]="#ADDFAD";r[523]="#E6A8D7";r[524]="#B19CD9";r[525]="#FFB6C1";r[526]="#E97451";r[527]="#FFA07A";r[528]="#FF9999";r[529]="#20B2AA";r[530]="#87CEFA";r[531]="#778899";r[532]="#B0C4DE";r[533]="#B38B6D";r[534]="#E68FAC";r[535]="#FFFFE0";r[536]="#C8A2C8";r[537]="#BFFF00";r[538]="#00FF00";r[539]="#32CD32";r[540]="#9DC209";r[541]="#195905";r[542]="#FAF0E6";r[543]="#C19A6B";r[544]="#6CA0DC";r[545]="#674C47";r[546]="#B86D29";r[547]="#6C2E1F";r[548]="#987456";r[549]="#FFE4CD";r[550]="#E62020";r[551]="#FF00FF";r[552]="#FF55A3";r[553]="#CA1F7B";r[554]="#D0417E";r[555]="#FF0090";r[556]="#9F4576";r[557]="#AAF0D1";r[558]="#F8F4FF";r[559]="#C04000";r[560]="#FBEC5D";r[561]="#6050DC";r[562]="#0BDA51";r[563]="#979AAA";r[564]="#FF8243";r[565]="#74C365";r[566]="#880085";r[567]="#C32148";r[568]="#800000";r[569]="#B03060";r[570]="#E0B0FF";r[571]="#915F6D";r[572]="#EF98AA";r[573]="#73C2FB";r[574]="#E5B73B";r[575]="#66DDAA";r[576]="#0000CD";r[577]="#E2062C";r[578]="#AF4035";r[579]="#F3E5AB";r[580]="#035096";r[581]="#1C352D";r[582]="#DDA0DD";r[583]="#BA55D3";r[584]="#0067A5";r[585]="#9370DB";r[586]="#BB3385";r[587]="#AA4069";r[588]="#3CB371";r[589]="#80DAEB";r[590]="#7B68EE";r[591]="#C9DC87";r[592]="#00FA9A";r[593]="#674C47";r[594]="#48D1CC";r[595]="#79443B";r[596]="#D9603B";r[597]="#C71585";r[598]="#F8B878";r[599]="#F8DE7E";r[600]="#FDBCB4";r[601]="#0A7E8C";r[602]="#9C7C38";r[603]="#E4007C";r[604]="#191970";r[605]="#004953";r[606]="#E3F988";r[607]="#FFC40C";r[608]="#3EB489";r[609]="#F5FFFA";r[610]="#98FF98";r[611]="#FFE4E1";r[612]="#FAEBD7";r[613]="#967117";r[614]="#73A9C2";r[615]="#AE0C00";r[616]="#8A9A5B";r[617]="#30BA8F";r[618]="#997A8D";var t=new Array;e.each(n.data.groups,function(n,i){e.each(i.values,function(n,i){if(e.inArray(i.label,t)==-1){t[t.length]=i.label;if(i.color!=undefined){r[n]=i.color}}})})}};s.setupcolors();return this.each(function(){var t=e(this)[0];var o=t.getContext("2d");i.width=e(this).width();i.height=e(this).height();i.paddingLeft=n.paddingLeft<15?15:n.paddingLeft;i.paddingTop=n.paddingTop<15?15:n.paddingTop;i.paddingRight=n.paddingRight<15?15:n.paddingRight;i.paddingBottom=n.paddingBottom<15?15:n.paddingBottom;if(n.showLegend&&n.data.groups.length>0){i.paddingRight+=s.getLargestLabel(o)+40;s.drawLegend(o)}var u=i.paddingTop;var a=i.height-i.paddingBottom-35;var f=i.paddingLeft;var l=i.width-i.paddingRight;var c=a-u;if(n.showLabels){o.font='bold 14px "lucida grande",tahoma,verdana,arial,sans-serif';o.textAlign="center";o.fillText(n.data.xLabel,(l+f)/2,a+45);s.drawVerticalLabel(o,i.paddingLeft,u+c/2);f+=14}o.font='11px "lucida grande",tahoma,verdana,arial,sans-serif';o.textBaseline="middle";o.textAlign="right";var h=s.getSmallestValue();var p=s.getLargestValue();var d=c/10;var v=0;if(h>=0){var m=new Array;for(var g=0;g<=10;g++){var y;if(g<10){y=p-p*(g*10/100)}else{y=0}var b=o.measureText(Math.round(y));if(b.width>v){v=b.width}m[g]=Math.round(y)}f=f+v;e.each(m,function(e,t){o.fillText(t,f,u+e*d);o.beginPath();o.strokeStyle="#CCCCCC";o.lineWidth=1;o.moveTo(f+5,Math.round(u+e*d)+.5);o.lineTo(l,Math.round(u+e*d)+.5);o.stroke();o.closePath()})}f=f+5;var w=l-f;var E=s.getBarCount();var S=15;var x=(w-S*(n.data.groups.length+1))/E;var T=f;o.font='11px "lucida grande",tahoma,verdana,arial,sans-serif';e.each(n.data.groups,function(t,i){T+=S;e.each(i.values,function(e,t){var i=c*(t.value/p);o.beginPath();o.rect(T,a-(i+0),x,i);o.fillStyle=r[e];o.fill();o.closePath();T+=x;if(n.data.groups.length==1){o.textAlign="center";o.fillStyle="black";o.fillText(t.label,T-x/2,a+15)}});if(n.data.groups.length>1){o.textAlign="center";o.fillStyle="black";o.fillText(i.label,T-i.values.length/2*x,a+15)}});o.beginPath();o.strokeStyle="#000000";o.lineWidth=1;o.moveTo(f+.5,u);o.lineTo(f+.5,a+.5);o.lineTo(l,a+.5);o.stroke();o.closePath()})}})(jQuery)